# Development Rules - Test-Driven Development (TDD) Approach

**ชื่อโครงการ:** Mega Care Connect
**ไฟล์:** `dev_rule.md`

**วัตถุประสงค์:** เพื่อกำหนดกฎและขั้นตอนการพัฒนาด้วยแนวทาง Test-Driven Development (TDD) ให้กับทีมพัฒนา เพื่อสร้างซอฟต์แวร์ที่มีคุณภาพสูง, บำรุงรักษาง่าย, และมีข้อผิดพลาดน้อยที่สุด

---

## 1. หลักการพื้นฐานของ TDD

เราจะยึดหลักการพัฒนาที่ว่า "ไม่เขียนโค้ด Production ใดๆ จนกว่าจะมี Test ที่ล้มเหลว (Failing Test) รองรับ" โดยมีเป้าหมายเพื่อให้ Test เป็นตัวขับเคลื่อนการออกแบบและการพัฒนาโค้ดทั้งหมด

## 2. วงจร TDD: Red-Green-Refactor

การพัฒนาฟีเจอร์ทุกส่วนจะต้องทำตามวงจรนี้อย่างเคร่งครัด:

### Phase 1: RED - เขียน Test ที่ล้มเหลว

*   **เลือก Requirement:** เลือกฟีเจอร์ย่อยๆ ที่ต้องการพัฒนา (เช่น "ผู้ใช้ต้องสามารถดึงสถานะการเชื่อมต่อบัญชีได้")
*   **เขียน Test Case:** เขียน Test อัตโนมัติสำหรับฟีเจอร์นั้นๆ ก่อนที่จะเขียนโค้ดจริง
*   **คาดหวังผลลัพธ์:** Test ที่เขียนขึ้นจะต้องคาดหวังผลลัพธ์ที่ถูกต้องตาม Requirement
*   **รัน Test:** สั่งรัน Test และยืนยันว่า Test นั้น **"ล้มเหลว" (RED)** เพราะยังไม่มีโค้ดจริงมารองรับ

### Phase 2: GREEN - เขียนโค้ดเพื่อให้ Test ผ่าน

*   **เขียนโค้ดน้อยที่สุด:** เขียนโค้ดในส่วนของ Production เพียงเท่าที่จำเป็น เพื่อทำให้ Test ที่ล้มเหลวในขั้นตอน RED กลับมา **"ผ่าน" (GREEN)**
*   **เป้าหมายคือให้ผ่าน:** ในขั้นตอนนี้ ยังไม่ต้องกังวลเรื่องความสวยงามของโค้ด (Clean Code) หรือประสิทธิภาพ ขอเพียงแค่ทำให้ Test ผ่านได้ก็พอ
*   **รัน Test อีกครั้ง:** ยืนยันว่า Test Case นั้นผ่านจริงๆ และไม่มี Test อื่นๆ ที่เคยผ่านกลับมาล้มเหลว (Regression)

### Phase 3: REFACTOR - ปรับปรุงโค้ด

*   **ปรับปรุงโค้ด Production:** เมื่อมี Test ที่เป็น GREEN คอยคุ้มกันแล้ว ให้เรากลับมาปรับปรุงโค้ดที่เพิ่งเขียนไปให้มีคุณภาพดีขึ้น เช่น ลดความซ้ำซ้อน (DRY), ตั้งชื่อตัวแปร/ฟังก์ชันให้สื่อความหมาย, ทำให้โค้ดอ่านง่ายขึ้น
*   **ปรับปรุงโค้ด Test (ถ้าจำเป็น):** อาจมีการปรับปรุง Test ให้กระชับและอ่านเข้าใจง่ายขึ้น
*   **ห้ามเปลี่ยนพฤติกรรม:** การ Refactor จะต้องไม่ทำให้พฤติกรรมของโปรแกรมเปลี่ยนไป
*   **รัน Test ตลอดเวลา:** หลังจากปรับแก้โค้ดทุกครั้ง ต้องรัน Test ทั้งหมดเพื่อให้มั่นใจว่าทุกอย่างยังคงทำงานถูกต้อง (All tests must remain GREEN)

## 3. TDD Workflow สำหรับ Mega Care Connect

### Backend (Python/FastAPI)

*   **เครื่องมือ:** `pytest`, `httpx` (สำหรับทดสอบ API), `pytest-mock`
*   **ขั้นตอนตัวอย่าง (Endpoint `GET /api/v1/users/status`):**
    *   **RED:** เขียน Test ใน `tests/test_users.py` เพื่อทดสอบการเรียก `/api/v1/users/status` โดยคาดหวังว่าจะได้รับ status 200 และ JSON `{ "isLinked": true }` เมื่อผู้ใช้เชื่อมต่อแล้ว -> รันแล้ว Test ล้มเหลว (404 Not Found)
    *   **GREEN:** ไปที่ `main.py` หรือ `routers/users.py` สร้าง Endpoint `/api/v1/users/status` ขึ้นมา แล้ว Hardcode ให้ trả về `{ "isLinked": true }` -> รันแล้ว Test ผ่าน
    *   **REFACTOR:** ปรับแก้โค้ดใน Endpoint ให้ไปดึงข้อมูลจาก Middleware หรือ Logic ตรวจสอบ Firestore จริงๆ, เพิ่มการจัดการ Dependency Injection, และทำให้โค้ดสะอาดขึ้น -> รัน Test อีกครั้งเพื่อให้แน่ใจว่ายังผ่าน

### Frontend (Vue.js)

*   **เครื่องมือ:** `Vitest`, `Vue Test Utils`, `msw` (Mock Service Worker สำหรับ Mock API)
*   **ขั้นตอนตัวอย่าง (หน้า Dashboard):**
    *   **RED:** เขียน Test ใน `components/Dashboard.spec.js` เพื่อทดสอบว่าเมื่อ Component ถูกสร้าง (mount) จะต้องแสดงชื่อผู้ใช้ และข้อมูลสรุป (เช่น "AHI: 2.8") -> รันแล้ว Test ล้มเหลว เพราะยังไม่มีการเรียก API และแสดงผล
    *   **GREEN:** ใน `components/Dashboard.vue` เพิ่ม Logic ใน `onMounted` เพื่อเรียก API (`GET /api/v1/reports/latest`) และนำผลลัพธ์มาแสดงใน template -> รัน Test (ที่ Mock API ไว้) แล้ว Test ผ่าน
    *   **REFACTOR:** แยก Logic การเรียก API ออกไปเป็น Service หรือ `composable function`, ปรับปรุง Template ให้สวยงามและอ่านง่าย -> รัน Test อีกครั้งเพื่อให้แน่ใจว่ายังผ่าน

## 4. Definition of Done (DoD)

Task หรือฟีเจอร์ใดๆ จะถือว่า **"เสร็จสิ้น"** ก็ต่อเมื่อเป็นไปตามเงื่อนไขต่อไปนี้ทั้งหมด:

*   มี Test อัตโนมัติครอบคลุมทั้ง Happy Path และ Edge Cases
*   Test ทั้งหมดในโปรเจกต์ต้องอยู่ในสถานะ **GREEN**
*   โค้ดทั้งในส่วนของ Production และ Test ผ่านการ Refactor ให้สะอาดและมีคุณภาพแล้ว
*   ฟีเจอร์ที่พัฒนาทำงานได้ถูกต้องตรงตาม `Requirement Specification`
*   (Optional) มี Code Coverage ไม่ต่ำกว่าเกณฑ์ที่ทีมตกลงกัน (เช่น 85%)