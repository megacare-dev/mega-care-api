# MegaCare API Development TODO

This document tracks the development tasks for implementing the MegaCare Connect API based on the functional and technical specifications.

## Phase 1: Core Patient Features

This phase focuses on implementing the essential features for the patient-facing side of the application.

### 1.1. Customer Profile Management
- [x] **Implement `POST /customers/me`:**
  - [x] Connect to Firestore.
  - [x] Check if a customer with the given UID already exists (return 409 Conflict).
  - [x] Create a new document in the `customers` collection using the user's Firebase UID as the document ID.
  - [x] Add `setupDate` with the current timestamp.
  - [x] Return the newly created customer data.
- [x] **Implement `GET /customers/me`:**
  - [x] Connect to Firestore.
  - [x] Fetch the document from `customers/{user_uid}`.
  - [x] If the document doesn't exist, return 404 Not Found.
  - [x] Return the customer data.

### 1.2. Equipment Management
- [ ] **Implement `POST /customers/me/devices`:**
  - [ ] Add a new document to the `customers/{user_uid}/devices` sub-collection.
  - [ ] Let Firestore auto-generate the document ID.
  - [ ] Add `addedDate` with the current timestamp.
  - [ ] Return the new device data including its ID.
- [ ] **Implement `GET /customers/me/devices`:**
  - [ ] Fetch all documents from the `customers/{user_uid}/devices` sub-collection.
  - [ ] Return the list of devices.
- [ ] **Create & Implement Mask Endpoints:**
  - [ ] Create `POST /customers/me/masks` endpoint in `customers.py`.
  - [ ] Implement logic to add a mask to the `masks` sub-collection.
  - [ ] Create `GET /customers/me/masks` endpoint in `customers.py`.
  - [ ] Implement logic to retrieve all masks.
- [ ] **Create & Implement Air Tubing Endpoints:**
  - [ ] Create `POST /customers/me/airTubing` endpoint in `customers.py`.
  - [ ] Implement logic to add tubing to the `airTubing` sub-collection.
  - [ ] Create `GET /customers/me/airTubing` endpoint in `customers.py`.
  - [ ] Implement logic to retrieve all air tubing.

### 1.3. Daily Reports (Patient)
- [ ] **Create & Implement Daily Report Endpoints:**
  - [ ] Create `POST /customers/me/dailyReports` endpoint in `customers.py`.
  - [ ] The document ID should be the report date in `YYYY-MM-DD` format.
  - [ ] Implement logic to add a new report to the `dailyReports` sub-collection.
  - [ ] Create `GET /customers/me/dailyReports` endpoint in `customers.py`.
  - [ ] Implement logic to retrieve a list of reports, ordered by date, with a `limit` parameter.

## Phase 2: Clinician Features

This phase focuses on the features required for clinicians to monitor their patients.

- [ ] **Implement `GET /clinician/patients`:**
  - [ ] Fetch the clinician's document to get the list of `assignedPatients` (UIDs).
  - [ ] For each patient UID, fetch the corresponding document from the `customers` collection.
  - [ ] Return the list of customer profiles.
  - [ ] *Note: Consider performance implications and potential for data denormalization.*
- [ ] **Implement `GET /clinician/patients/{patientId}/dailyReports`:**
  - [ ] Implement authorization: Verify the requested `patientId` is in the clinician's `assignedPatients` list. Return 403 Forbidden if not.
  - [ ] Fetch reports from `customers/{patientId}/dailyReports`.
  - [ ] Order by date descending and apply the `limit`.
  - [ ] Return the list of reports.

## Phase 3: Testing & Refinement

- [ ] **Write Unit/Integration Tests:**
  - [ ] Write tests for `customers.py` endpoints.
  - [ ] Write tests for `clinicians.py` endpoints.
  - [ ] Mock Firestore interactions for predictable test outcomes.
- [ ] **Authentication:**
  - [ ] Confirm the `get_current_user` dependency correctly validates Firebase Auth ID tokens as specified in `fs_ts.md`. The current `app/dependencies/auth.py` is for LINE Login, which might be a separate requirement or needs to be replaced/augmented.
- [ ] **Error Handling:**
  - [ ] Review all endpoints for consistent and informative error responses (e.g., 404, 409, 403).
- [ ] **Documentation:**
  - [ ] Ensure OpenAPI/Swagger documentation generated by FastAPI is clean and accurate.
  - [ ] Update `README.md` with setup and run instructions if needed.