# MegaCare API Development TODO

This document tracks the development tasks for implementing the MegaCare Connect API based on the functional and technical specifications.

## Phase 1: Core Patient Features

This phase focuses on implementing the essential features for the patient-facing side of the application.

### 1.1. Customer Profile Management
- [x] **@router.get("/me", response_model=schemas.Customer)
def get_my_profile(current_user: Dict = Depends(get_current_user)):
    """
    Retrieve the profile of the currently authenticated user.
    """
    db = firestore.client()
    user_uid = current_user["uid"]
    customer_ref = db.collection("customers").document(user_uid)
    doc = customer_ref.get()
    if not doc.exists:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Customer profile not found")

    response_data = doc.to_dict()
    response_data["patientId"] = doc.id
    return response_data

  - [x] Connect to Firestore.
  - [x] Check if a customer with the given UID already exists (return 409 Conflict).
  - [x] Create a new document in the `customers` collection using the user's Firebase UID as the document ID.
  - [x] Add `setupDate` with the current timestamp.
  - [x] Return the newly created customer data.
- [x] **Implement `GET /customers/me`:**
  - [x] Connect to Firestore.
  - [x] Fetch the document from `customers/{user_uid}`.
  - [x] If the document doesn't exist, return 404 Not Found.
  - [x] Return the customer data.

### 1.2. Equipment Management
- [x] **Implement `POST /customers/me/devices`:**
  - [x] Add a new document to the `customers/{user_uid}/devices` sub-collection.
  - [x] Let Firestore auto-generate the document ID.
  - [x] Add `addedDate` with the current timestamp.
  - [x] Return the new device data including its ID.
- [x] **Implement `GET /customers/me/devices`:**
  - [x] Fetch all documents from the `customers/{user_uid}/devices` sub-collection.
  - [x] Return the list of devices.
- [x] **Create & Implement Mask Endpoints:**
  - [x] Create `POST /customers/me/masks` endpoint in `customers.py`.
  - [x] Implement logic to add a mask to the `masks` sub-collection.
  - [x] Create `GET /customers/me/masks` endpoint in `customers.py`.
  - [x] Implement logic to retrieve all masks.
- [x] **Create & Implement Air Tubing Endpoints:**
  - [x] Create `POST /customers/me/airTubing` endpoint in `customers.py`.
  - [x] Implement logic to add tubing to the `airTubing` sub-collection.
  - [x] Create `GET /customers/me/airTubing` endpoint in `customers.py`.
  - [x] Implement logic to retrieve all air tubing.

### 1.3. Daily Reports (Patient)
- [x] **Create & Implement Daily Report Endpoints:**
  - [x] Create `POST /customers/me/dailyReports` endpoint in `customers.py`.
  - [x] The document ID should be the report date in `YYYY-MM-DD` format.
  - [x] Implement logic to add a new report to the `dailyReports` sub-collection.
  - [x] Create `GET /customers/me/dailyReports` endpoint in `customers.py`.
  - [x] Implement logic to retrieve a list of reports, ordered by date, with a `limit` parameter.

## Phase 2: Clinician Features

This phase focuses on the features required for clinicians to monitor their patients.

- [ ] **Implement `GET /clinician/patients`:**
  - [x] Fetch the clinician's document to get the list of `assignedPatients` (UIDs).
  - [x] For each patient UID, fetch the corresponding document from the `customers` collection.
  - [x] Return the list of customer profiles.
  - [x] *Note: Consider performance implications and potential for data denormalization.*
- [ ] **Implement `GET /clinician/patients/{patientId}/dailyReports`:**
  - [x] Implement authorization: Verify the requested `patientId` is in the clinician's `assignedPatients` list. Return 403 Forbidden if not.
  - [x] Fetch reports from `customers/{patientId}/dailyReports`.
  - [x] Order by date descending and apply the `limit`.
  - [x] Return the list of reports.

## Phase 3: Testing & Refinement

- [x] **Write Unit/Integration Tests:**
  - [x] Write tests for `customers.py` endpoints.
  - [x] Write tests for `clinicians.py` endpoints.
  - [x] Mock Firestore interactions for predictable test outcomes.
- [x] **Authentication:**
  - [x] Confirm the `get_current_user` dependency correctly validates Firebase Auth ID tokens as specified in `fs_ts.md`.
- [x] **Error Handling:**
  - [x] Review all endpoints for consistent and informative error responses (e.g., 404, 409, 403).
- [x] **Documentation:**
  - [x] Ensure OpenAPI/Swagger documentation generated by FastAPI is clean and accurate.
  - [x] Update `README.md` with setup and run instructions.

## Phase 4: LINE Login and User Onboarding

This phase outlines the server-side authentication flow using LINE Login and the subsequent process for linking a user to their device data.

- [x] **Implement LINE Login Endpoint: `POST /api/v1/auth/line`**
  - [x] This endpoint will exchange a LINE authorization code for a Firebase Custom Token.
  - [x] Create a new router file: `app/api/v1/endpoints/auth.py`.
  - [x] Receive `authorization_code` and `redirect_uri` from the client.
  - [x] Make a server-to-server request to the LINE Platform to exchange the code for an `access_token` and `id_token`.
  - [x] Verify the LINE `id_token` and extract the user's profile (LINE User ID, email, name, picture).
  - [x] Use the LINE User ID to find or create a user in Firebase Authentication.
  - [x] Generate a Firebase Custom Token for the user and return it to the client.

- [ ] **(Optional) Implement LINE Profile Retrieval Endpoint: `POST /api/v1/auth/line/profile`**
  - [ ] Create an endpoint to exchange a LINE authorization code for the user's LINE profile data, without creating a Firebase user.

- [X] **Implement Device Linking Endpoint: `POST /api/v1/customers/me/link-device`**
  - [X] This endpoint will be protected and require a standard Firebase Auth ID Token.
  - [X] Receive the device Serial Number (SN) from the client.
  - [X] Find the device in the `devices` sub-collection group using the provided SN.
  - [X] If a matching device is found, get its parent customer profile and add it customer document to patients collection by use customer's document id 
  - [X] Return the updated user profile on success or an error on failure.

- [ ] **(Recommended) Create Firestore User on Auth Creation**
  - [ ] Implement a Firebase Cloud Function with an `onUserCreate` trigger.
  - [ ] This function will automatically create a corresponding user profile document in the `customers` collection in Firestore whenever a new user is created in Firebase Authentication. This ensures user data consistency.
  - [ ] Design the `customers` schema to potentially include a `role` field.