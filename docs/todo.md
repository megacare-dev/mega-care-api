# MegaCare API Development TODO

This document tracks the development tasks for implementing the MegaCare Connect API based on the functional and technical specifications.
## Phase 1: Core Patient Features

This phase focuses on implementing the essential features for the patient-facing side of the application.

### 1.1. Customer Profile Management
- [x] **Implement `POST /customers/me` (Create Profile):**
  - [x] Endpoint is called after a user is created in Firebase Auth (e.g., via email/password).
  - [x] Requires a valid Firebase ID Token for the new user.
  - [x] Receives profile data in the request body, including `firstName`, `lastName`, and `lineId`.
  - [x] Checks if a customer profile for this UID already exists (return 409 Conflict).
  - [x] Creates a new document in the `customers` collection using the user's Firebase UID as the document ID.
  - [x] Stores all profile data, including the `lineId` to link the LINE account to the Firebase account.
  - [x] Adds `setupDate` with the current timestamp.
  - [x] Returns the newly created customer data.
- [x] **Implement `GET /customers/me` (Get Profile):**
  - [x] Connect to Firestore.
  - [x] Requires a valid Firebase ID Token.
  - [x] Fetch the document from `customers/{user_uid}`.
  - [x] If the document doesn't exist, return 404 Not Found.
  - [x] Return the customer data.

### 1.2. Equipment Management
- [x] **Implement `POST /customers/me/devices`:**
  - [x] Add a new document to the `customers/{user_uid}/devices` sub-collection.
  - [x] Let Firestore auto-generate the document ID.
  - [x] Add `addedDate` with the current timestamp.
  - [x] Return the new device data including its ID.
- [x] **Implement `GET /customers/me/devices`:**
  - [x] Fetch all documents from the `customers/{user_uid}/devices` sub-collection.
  - [x] Return the list of devices.
- [x] **Create & Implement Mask Endpoints:**
  - [x] Create `POST /customers/me/masks` endpoint in `customers.py`.
  - [x] Implement logic to add a mask to the `masks` sub-collection.
  - [x] Create `GET /customers/me/masks` endpoint in `customers.py`.
  - [x] Implement logic to retrieve all masks.
- [x] **Create & Implement Air Tubing Endpoints:**
  - [x] Create `POST /customers/me/airTubing` endpoint in `customers.py`.
  - [x] Implement logic to add tubing to the `airTubing` sub-collection.
  - [x] Create `GET /customers/me/airTubing` endpoint in `customers.py`.
  - [x] Implement logic to retrieve all air tubing.

### 1.3. Daily Reports (Patient)
- [x] **Create & Implement Daily Report Endpoints:**
  - [x] Create `POST /customers/me/dailyReports` endpoint in `customers.py`.
  - [x] The document ID should be the report date in `YYYY-MM-DD` format.
  - [x] Implement logic to add a new report to the `dailyReports` sub-collection.
  - [x] Create `GET /customers/me/dailyReports` endpoint in `customers.py`.
  - [x] Implement logic to retrieve a list of reports, ordered by date, with a `limit` parameter.

## Phase 2: Clinician Features

This phase focuses on the features required for clinicians to monitor their patients.

- [ ] **Implement `GET /clinician/patients`:**
  - [x] Fetch the clinician's document to get the list of `assignedPatients` (UIDs).
  - [x] For each patient UID, fetch the corresponding document from the `customers` collection.
  - [x] Return the list of customer profiles.
  - [x] *Note: Consider performance implications and potential for data denormalization.*
- [ ] **Implement `GET /clinician/patients/{patientId}/dailyReports`:**
  - [x] Implement authorization: Verify the requested `patientId` is in the clinician's `assignedPatients` list. Return 403 Forbidden if not.
  - [x] Fetch reports from `customers/{patientId}/dailyReports`.
  - [x] Order by date descending and apply the `limit`.
  - [x] Return the list of reports.

## Phase 3: Testing & Refinement

- [x] **Write Unit/Integration Tests:**
  - [x] Write tests for `customers.py` endpoints.
  - [x] Write tests for `clinicians.py` endpoints.
  - [x] Mock Firestore interactions for predictable test outcomes.
- [x] **Authentication:**
  - [x] Confirm the `get_current_user` dependency correctly validates Firebase Auth ID tokens as specified in `fs_ts.md`.
- [x] **Error Handling:**
  - [x] Review all endpoints for consistent and informative error responses (e.g., 404, 409, 403).
- [x] **Documentation:**
  - [x] Ensure OpenAPI/Swagger documentation generated by FastAPI is clean and accurate.
  - [x] Update `README.md` with setup and run instructions.

## Phase 4: User Onboarding & Authentication

This phase outlines the "Login or Register" flow using LINE and Email, user profile creation, and device linking.

- [x] **Implement Combined LINE Login/Register Endpoint: `POST /api/v1/auth/line`**
  - [x] This endpoint handles both login for existing users and the first step of registration for new users.
  - [x] Receive `authorization_code` from the client.
  - [x] Exchange the code for a LINE `id_token` to get the `line_user_id`.
  - [x] **Search the `customers` collection for a document with a matching `lineId`.**
    - [x] **If user exists (Login Flow):**
      - [x] Use the user's `firebaseUid` (stored in the customer document) to generate a Firebase Custom Token.
      - [x] Return the Custom Token to the client for login (`signInWithCustomToken`).
    - [x] **If user does not exist (Registration Flow):**
      - [x] Return a "register" status along with the user's LINE profile data (name, picture).
      - [x] The client will then redirect to a registration page to complete signup (create email/password account).

- [x] **Implement Device Linking as a Separate Action: `POST /api/v1/customers/me/link-device`**
  - [x] This endpoint is protected and used by an authenticated user at any time post-login.
  - [x] Receive the device Serial Number (SN) from the client.
  - [x] Find the device with a status of "unlinked" using a `collection_group` query across all `devices` collections.
  - [x] If a matching device is found:
    - [x] Identify the associated pre-existing patient profile. This profile could be the parent document in the `customers` collection OR a document in the `patient_list` collection referenced by a `patientId` field in the device document.
    - [x] Merge the data from the found profile into the current user's `customers` document, preserving the user's LINE profile information.
    - [x] If the device document contained a `patientId`, ensure the profile is also stored/updated in the `patient_list` collection, linking it to the current user's ID.
    - [x] Update the original device document to link it to the current user (set status to "active", add `customerId`).
    - [x] Add a record of the linked device to the current user's `devices` sub-collection for consistency.
  - [x] Return the updated user profile on success or an error on failure.

- [ ] **Future Improvements**
  - [ ] Consider using a Firebase Cloud Function with an `onUserCreate` trigger to create the initial Firestore customer document, simplifying client-side logic.
  - [ ] Finalize the `customers` schema, potentially including a `role` field for future use.